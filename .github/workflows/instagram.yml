name: Update Instagram Feed

on:
  schedule:
    - cron: "0 */6 * * *"   # každých 6 hodin
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Instagram Profile + Feed
        env:
          IG_TOKEN: ${{ secrets.IG_TOKEN }}
          IG_ID: "17841477970120373"
        run: |
          set -euo pipefail

          # 1) Profil (počty + username + avatar)
          curl -sS "https://graph.facebook.com/v25.0/${IG_ID}?fields=id,username,profile_picture_url,followers_count,follows_count,media_count&access_token=${IG_TOKEN}" > profile.json

          # 2) Feed (mix všeho). limit si uprav dle potřeby
          curl -sS "https://graph.facebook.com/v25.0/${IG_ID}/media?fields=id,caption,media_type,media_url,permalink,thumbnail_url,timestamp&limit=50&access_token=${IG_TOKEN}" > feed.json

          node <<'EOF'
          const fs = require("fs");

          const profile = JSON.parse(fs.readFileSync("profile.json","utf8"));
          const feed = JSON.parse(fs.readFileSync("feed.json","utf8"));

          // fail fast pokud Graph vrací error
          if (profile.error) { console.error("Profile error:", profile.error); process.exit(1); }
          if (feed.error)    { console.error("Feed error:", feed.error); process.exit(1); }

          const items = (feed.data || []).map(x => ({
            id: x.id,
            caption: x.caption || "",
            media_type: x.media_type,                 // IMAGE | VIDEO | CAROUSEL_ALBUM
            media_url: x.media_url || "",
            thumbnail_url: x.thumbnail_url || "",     // pro VIDEO často existuje
            permalink: x.permalink || "",
            timestamp: x.timestamp || ""
          }));

          const out = {
            updated_at: new Date().toISOString(),
            profile: {
              id: profile.id,
              username: profile.username,
              profile_picture_url: profile.profile_picture_url || "",
              posts: profile.media_count ?? null,
              followers: profile.followers_count ?? null,
              following: profile.follows_count ?? null  // někdy nebude -> null
            },
            items
          };

          fs.writeFileSync("data.json", JSON.stringify(out, null, 2));
          console.log("Wrote data.json:", { items: items.length, profile: out.profile });
          EOF

      - name: Commit changes
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data.json
          git diff --cached --quiet && { echo "No changes"; exit 0; }
          git commit -m "Update Instagram feed"
          git push
