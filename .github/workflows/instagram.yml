name: Update Instagram Feed

on:
  schedule:
    - cron: "0 */6 * * *"   # každých 6 hodin
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Instagram Profile + Feed (with fallback)
        env:
          IG_TOKEN: ${{ secrets.IG_TOKEN }}
          IG_ID: "17841477970120373"
        run: |
          set -euo pipefail

          echo "Fetching profile..."
          curl -sS "https://graph.facebook.com/v25.0/${IG_ID}?fields=id,username,profile_picture_url,followers_count,follows_count,media_count&access_token=${IG_TOKEN}" > profile.json

          echo "Fetching feed with like_count + comments_count..."
          curl -sS "https://graph.facebook.com/v25.0/${IG_ID}/media?fields=id,caption,media_type,media_url,permalink,thumbnail_url,timestamp,like_count,comments_count&limit=50&access_token=${IG_TOKEN}" > feed.json

          node <<'EOF'
          const fs = require("fs");

          const profile = JSON.parse(fs.readFileSync("profile.json","utf8"));
          let feed = JSON.parse(fs.readFileSync("feed.json","utf8"));

          if (profile.error) {
            console.error("Profile error:", profile.error);
            process.exit(1);
          }

          // === FEED FALLBACK ===
          if (feed.error) {
            console.warn("Primary feed request failed. Retrying without like/comment fields...");

            const { execSync } = require("child_process");

            execSync(
              `curl -sS "https://graph.facebook.com/v25.0/${process.env.IG_ID}/media?fields=id,caption,media_type,media_url,permalink,thumbnail_url,timestamp&limit=50&access_token=${process.env.IG_TOKEN}" > feed.json`
            );

            feed = JSON.parse(fs.readFileSync("feed.json","utf8"));

            if (feed.error) {
              console.error("Fallback feed also failed:", feed.error);
              process.exit(1);
            }
          }

          const items = (feed.data || []).map(x => ({
            id: x.id,
            caption: x.caption || "",
            media_type: x.media_type,
            media_url: x.media_url || "",
            thumbnail_url: x.thumbnail_url || "",
            permalink: x.permalink || "",
            timestamp: x.timestamp || "",
            like_count: typeof x.like_count === "number" ? x.like_count : null,
            comments_count: typeof x.comments_count === "number" ? x.comments_count : null
          }));

          const out = {
            updated_at: new Date().toISOString(),
            profile: {
              id: profile.id,
              username: profile.username,
              profile_picture_url: profile.profile_picture_url || "",
              posts: profile.media_count ?? null,
              followers: profile.followers_count ?? null,
              following: profile.follows_count ?? null
            },
            items
          };

          fs.writeFileSync("data.json", JSON.stringify(out, null, 2));
          console.log("Wrote data.json:", { items: items.length });
          EOF

      - name: Commit changes
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data.json
          git diff --cached --quiet && { echo "No changes"; exit 0; }
          git commit -m "Update Instagram feed"
          git push
